<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>ìì¬ ëª©ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; vertical-align: middle; }
        th { background-color: #f8f9fa; }
        .danger { color: red; font-weight: bold; }
        a { text-decoration: none; }

        /* AI ì±„íŒ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìš°ì¸¡ í•˜ë‹¨ ê³ ì •) */
        #chatModal {
            display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            flex-direction: column;
            border: 1px solid #ddd;
            min-width: 300px;
            max-width: 800px;
        }

        /* ì±„íŒ…ì°½ í—¤ë” */
        .chat-header {
            background-color: #0d6efd;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        /* ë‹«ê¸° ë²„íŠ¼ */
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        /* ì±„íŒ… ë‚´ìš© ì˜ì—­ */
        .chat-box {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f1f3f5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .message { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; word-wrap: break-word; }
        .my-message { align-self: flex-end; background-color: #ffe066; color: black; border-bottom-right-radius: 0; }
        .ai-message { align-self: flex-start; background-color: white; border: 1px solid #ddd; border-bottom-left-radius: 0; }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        .input-area {
            padding: 10px;
            background-color: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 5px;
        }
        #sendBtn{
            white-space: nowrap;
            flex-shrink: 0;
            width: auto;
        }
    </style>
</head>
<body class="container py-5">

<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h2 class="m-0">ğŸ“‹ ìì¬ í˜„í™© ë¦¬ìŠ¤íŠ¸</h2>

    <div class="d-flex align-items-center gap-2">
        <span class="me-3 fw-bold text-secondary">
            ğŸ‘¤ <span id="loggedInUser" sec:authentication="name">ì‚¬ìš©ì</span>ë‹˜
        </span>

        <button sec:authorize="hasRole('ADMIN')"
                id="approvalBtn"
                onclick="openApprovalModal()"
                class="btn btn-warning btn-sm fw-bold text-white">
            ğŸ”” ê²°ì¬ ëŒ€ê¸° (<span id="pendingCount">0</span>)
        </button>

        <a href="/product/upload" class="btn btn-primary btn-sm">â• ì—‘ì…€ ë“±ë¡</a>
        <button onclick="toggleChat()" class="btn btn-success btn-sm">ğŸ¤– AI ë¹„ì„œ</button>
        <a href="/logout"
           onclick="sessionStorage.clear()"
           class="btn btn-danger btn-sm">
            ë¡œê·¸ì•„ì›ƒ
        </a>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-3">
        <div class="card shadow-sm h-100 border-0 bg-light">
            <div class="card-body text-center d-flex flex-column justify-content-center align-items-center">
                <div>
                    <h5 class="card-title text-muted mb-3">ì´ í’ˆëª© ìˆ˜</h5>
                    <h1 class="display-4 fw-bold text-dark" th:text="${lowStockCount + safeStockCount}">0</h1>
                    <span class="badge bg-secondary rounded-pill mt-2">ê°œ ë“±ë¡ë¨</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card shadow-sm h-100 border-0">
            <div class="card-body d-flex align-items-center justify-content-center p-4">
                <div style="width: 250px; height: 250px; flex-shrink: 0;">
                    <canvas id="stockChart"></canvas>
                </div>
                <div class="ms-5 text-nowrap">
                    <h4 class="mb-4 fw-bold">ì¬ê³  ìƒíƒœ ë¹„ìœ¨</h4>
                    <div class="d-flex align-items-center mb-3">
                        <span style="width: 20px; height: 20px; background-color: #198754; border-radius: 5px; margin-right: 15px;"></span>
                        <span class="fs-5">ì •ìƒ ì¬ê³ : <strong class="text-success" th:text="${safeStockCount}"></strong>ê°œ</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <span style="width: 20px; height: 20px; background-color: #dc3545; border-radius: 5px; margin-right: 15px;"></span>
                        <span class="fs-5 text-danger">ë°œì£¼ í•„ìš”: <strong th:text="${lowStockCount}"></strong>ê°œ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<table class="table table-hover">
    <thead>
    <tr>
        <th>ID</th>
        <th>í’ˆëª©ëª…</th>
        <th>ë‹¨ê°€</th>
        <th>í˜„ì¬ê³ </th>
        <th>ì•ˆì „ì¬ê³ </th>
        <th>ìƒíƒœ</th>
        <th sec:authorize="hasRole('ADMIN')">ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${productList}">
        <td th:text="${item.id}">1</td>
        <td th:text="${item.name}">í’ˆëª©ëª…</td>
        <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + 'ì›'}">10,000ì›</td>
        <td th:text="${item.stockQuantity}">100</td>
        <td th:text="${item.safetyStock}">10</td>
        <td>
            <span th:if="${item.stockQuantity < item.safetyStock}" class="badge bg-danger">ğŸš¨ ë°œì£¼í•„ìš”</span>
            <span th:unless="${item.stockQuantity < item.safetyStock}" class="badge bg-success">ì •ìƒ</span>
        </td>
        <td sec:authorize="hasRole('ADMIN')">
            <a th:href="@{/product/edit/{id}(id=${item.id})}" class="btn btn-sm btn-outline-primary">ìˆ˜ì •</a>
        </td>
    </tr>
    </tbody>
</table>

<div th:if="${!productList.isEmpty()}">
    <ul class="pagination justify-content-center">
        <li class="page-item" th:classappend="${productList.first} ? 'disabled'">
            <a class="page-link" th:href="@{/product/list(page=${productList.number - 1})}">
                <span>&laquo; ì´ì „</span>
            </a>
        </li>

        <li th:each="page: ${#numbers.sequence(0, productList.totalPages - 1)}"
            th:if="${page >= productList.number - 2 and page <= productList.number + 2}"
            class="page-item"
            th:classappend="${page == productList.number} ? 'active'">
            <a class="page-link" th:text="${page + 1}" th:href="@{/product/list(page=${page})}">1</a>
        </li>

        <li class="page-item" th:classappend="${productList.last} ? 'disabled'">
            <a class="page-link" th:href="@{/product/list(page=${productList.number + 1})}">
                <span>ë‹¤ìŒ &raquo;</span>
            </a>
        </li>
    </ul>
</div>

<div id="approvalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="background: white; width: 600px; margin: 100px auto; padding: 20px; border-radius: 10px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h3 class="mb-3">ğŸ“‘ ê²°ì¬ ëŒ€ê¸° ëª©ë¡</h3>
        <button onclick="closeApprovalModal()" style="position: absolute; top: 15px; right: 20px; border: none; background: transparent; font-size: 24px; cursor: pointer;">&times;</button>

        <table class="table table-bordered mb-0">
            <thead class="table-light">
            <tr>
                <th>í’ˆëª©</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê¸°ì•ˆì</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="approvalListBody">
            </tbody>
        </table>
    </div>
</div>

<div id="chatModal">
    <div class="chat-header">
        <span>ğŸ¤– AI ì¬ê³  ë¹„ì„œ</span>
        <button class="close-btn" onclick="toggleChat()">&times;</button>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="message ai-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <div class="input-area">
        <input type="text" id="questionInput" class="form-control" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="handleEnter(event)">
        <button onclick="sendQuestion()" id="sendBtn" class="btn btn-primary btn-sm">ì „ì†¡</button>
    </div>
</div>

<script>
    const STORAGE_KEY_HISTORY = "chatHistory";
    const STORAGE_KEY_STATE = "chatState";
    const STORAGE_KEY_POSITION = "chatPosition";
    const STORAGE_KEY_SIZE = "chatSize";
    const STORAGE_KEY_USER = "chatUser";

    document.addEventListener("DOMContentLoaded", function() {
        // ë¡œê·¸ì¸ ì§í›„ë¼ë©´ ì„¤ì • ì´ˆê¸°í™”
        if (document.referrer.includes('/login')) {
            sessionStorage.clear();
        }

        // ì‚¬ìš©ì ë³€ê²½ ì²´í¬
        const userSpan = document.getElementById('loggedInUser');
        if (userSpan) {
            const currentUser = userSpan.innerText.trim();
            const savedUser = sessionStorage.getItem(STORAGE_KEY_USER);

            if (savedUser && savedUser !== currentUser) {
                sessionStorage.clear();
            }
            sessionStorage.setItem(STORAGE_KEY_USER, currentUser);
        }

        // ê´€ë¦¬ììš© ê²°ì¬ ë²„íŠ¼ ì²´í¬
        if(document.getElementById('approvalBtn')){
            fetchPendingApprovals();
        }

        // ì±„íŒ…ì°½ ìƒíƒœ ë³µêµ¬ (ìœ„ì¹˜, í¬ê¸°, ì—´ë¦¼ì—¬ë¶€)
        const modal = document.getElementById('chatModal');
        const savedPos = sessionStorage.getItem(STORAGE_KEY_POSITION);
        const savedSize = sessionStorage.getItem(STORAGE_KEY_SIZE);

        if (modal) {
            if (savedPos) {
                const pos = JSON.parse(savedPos);
                modal.style.top = pos.top + "px";
                modal.style.left = pos.left + "px";
                modal.style.bottom = "auto";
                modal.style.right = "auto";
            }
            if (savedSize) {
                const size = JSON.parse(savedSize);
                modal.style.width = size.width + "px";
                modal.style.height = size.height + "px";
            }
        }

        // jQuery UI ë“œë˜ê·¸ & ë¦¬ì‚¬ì´ì¦ˆ
        if (typeof $ !== 'undefined') {
            $("#chatModal").draggable({
                handle: ".chat-header",
                containment: "window",
                stop: function(event, ui) {
                    sessionStorage.setItem(STORAGE_KEY_POSITION, JSON.stringify(ui.position));
                }
            });

            $("#chatModal").resizable({
                handles: "all",
                minHeight: 400, minWidth: 300,
                stop: function(event, ui) {
                    sessionStorage.setItem(STORAGE_KEY_SIZE, JSON.stringify(ui.size));
                }
            });
        }

        // ì±„íŒ…ì°½ ì—´ë ¤ìˆì—ˆë‹¤ë©´ ë‹¤ì‹œ ì—´ê¸°
        const chatState = sessionStorage.getItem(STORAGE_KEY_STATE);
        if (chatState === 'open' && modal) {
            modal.style.display = 'flex';
            setTimeout(() => {
                const chatBox = document.getElementById('chatBox');
                if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
        }

        // ëŒ€í™” ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadChatHistory();
    });

    // --- ì±„íŒ… UI í•¨ìˆ˜ ---
    function toggleChat() {
        const modal = document.getElementById('chatModal');
        if (modal.style.display === 'none' || modal.style.display === '') {
            modal.style.display = 'flex';
            document.getElementById('questionInput').focus();
            sessionStorage.setItem(STORAGE_KEY_STATE, 'open');
            setTimeout(() => {
                const chatBox = document.getElementById('chatBox');
                if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
            }, 10);
        } else {
            modal.style.display = 'none';
            sessionStorage.setItem(STORAGE_KEY_STATE, 'closed');
        }
    }

    function loadChatHistory() {
        const savedHistory = sessionStorage.getItem(STORAGE_KEY_HISTORY);
        const chatBox = document.getElementById('chatBox');
        if (savedHistory && chatBox) {
            chatBox.innerHTML = '';
            const greetingDiv = document.createElement('div');
            greetingDiv.classList.add('message', 'ai-message');
            greetingDiv.innerText = "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?";
            chatBox.appendChild(greetingDiv);

            const historyArray = JSON.parse(savedHistory);
            historyArray.forEach(msg => {
                renderMessage(msg.text, msg.className, null, false);
            });
            setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 10);
        }
    }

    function saveChatHistory(text, className) {
        let history = JSON.parse(sessionStorage.getItem(STORAGE_KEY_HISTORY)) || [];
        if (history.length === 0 && text.includes("ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”")) return;
        history.push({ text: text, className: className });
        sessionStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
    }

    function addMessage(text, className, id = null) {
        renderMessage(text, className, id, true);
    }

    function renderMessage(text, className, id, saveFlag) {
        const chatBox = document.getElementById('chatBox');
        if (!chatBox) return;

        const div = document.createElement('div');
        div.classList.add('message', className);
        div.innerText = text;
        if (id) div.id = id;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;

        if (saveFlag && id === null && text !== '...') {
            saveChatHistory(text, className);
        }
    }

    function handleEnter(event) {
        if (event.key === 'Enter') sendQuestion();
    }

    async function sendQuestion() {
        const input = document.getElementById('questionInput');
        const sendBtn = document.getElementById('sendBtn');
        const question = input.value.trim();

        if (!question) return;

        addMessage(question, 'my-message');
        input.value = '';
        input.disabled = true;
        sendBtn.disabled = true;

        const loadingId = 'loading-' + Date.now();
        addMessage('...', 'ai-message', loadingId);

        try {
            const response = await fetch(`/ai/ask?q=${encodeURIComponent(question)}`);
            const answer = await response.text();

            const loadingBubble = document.getElementById(loadingId);
            if (loadingBubble) loadingBubble.remove();

            addMessage(answer, 'ai-message');

            if (answer.includes("ì™„ë£Œ") || answer.includes("ì„±ê³µ") || answer.includes("ì·¨ì†Œ") || answer.includes("ê¸°ì•ˆ")) {
                setTimeout(() => refreshTable(), 1000);
            }
        } catch (error) {
            const loadingBubble = document.getElementById(loadingId);
            if (loadingBubble) loadingBubble.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        } finally {
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
    }

    // --- ê²°ì¬ ë° í…Œì´ë¸” ê°±ì‹  í•¨ìˆ˜ ---
    function fetchPendingApprovals() {
        fetch('/api/approval/pending')
            .then(res => res.json())
            .then(data => {
                if(document.getElementById('pendingCount')) document.getElementById('pendingCount').innerText = data.length;
                renderApprovalList(data);
            })
            .catch(e => console.error(e));
    }

    function openApprovalModal() {
        fetchPendingApprovals();
        document.getElementById('approvalModal').style.display = 'block';
    }

    function closeApprovalModal() {
        document.getElementById('approvalModal').style.display = 'none';
    }

    function renderApprovalList(list) {
        const tbody = document.getElementById('approvalListBody');
        if(!tbody) return;
        tbody.innerHTML = '';
        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">ëŒ€ê¸° ì¤‘ì¸ ê²°ì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }
        list.forEach(item => {
            const productName = item.product ? item.product.name : "ìƒí’ˆì •ë³´ì—†ìŒ";
            const row = `
                <tr>
                    <td>${productName}</td>
                    <td>${item.quantity}ê°œ</td>
                    <td>${item.requesterName}</td>
                    <td>
                        <button onclick="processApproval(${item.id}, 'approve')" class="btn btn-success btn-sm">ìŠ¹ì¸</button>
                        <button onclick="processApproval(${item.id}, 'reject')" class="btn btn-danger btn-sm">ë°˜ë ¤</button>
                    </td>
                </tr>`;
            tbody.innerHTML += row;
        });
    }

    function processApproval(id, action) {
        if(!confirm(action === 'approve' ? "ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch(`/approval/${id}/${action}`, { method: 'POST' })
            .then(res => {
                if(res.ok) {
                    alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    fetchPendingApprovals();
                    if(action === 'approve') refreshTable();
                } else alert("ì²˜ë¦¬ ì‹¤íŒ¨!");
            });
    }

    async function refreshTable() {
        try {
            const response = await fetch(window.location.href);
            const htmlText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const newTbody = doc.querySelector('tbody');
            const currentTbody = document.querySelector('tbody');
            if (newTbody && currentTbody) {
                currentTbody.innerHTML = newTbody.innerHTML;
                currentTbody.style.transition = "background-color 0.5s";
                currentTbody.style.backgroundColor = "#e8f0fe";
                setTimeout(() => currentTbody.style.backgroundColor = "transparent", 500);
            }
            if(document.getElementById('approvalBtn')) fetchPendingApprovals();
        } catch (e) { console.error(e); }
    }
</script>

<script th:inline="javascript">
    const safeCount = /*[[${safeStockCount}]]*/ 0;
    const dangerCount = /*[[${lowStockCount}]]*/ 0;

    const ctx = document.getElementById('stockChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['ì •ìƒ', 'ë¶€ì¡±'],
            datasets: [{
                data: [safeCount, dangerCount],
                backgroundColor: ['#198754', '#dc3545'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return ' ' + context.label + ': ' + context.raw + 'ê°œ';
                        }
                    }
                }
            },
            cutout: '70%',
        }
    });
</script>

</body>
</html>