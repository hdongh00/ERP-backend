<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>ìì¬ ëª©ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <style>
        /* ê¸°ë³¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; vertical-align: middle; }
        th { background-color: #f8f9fa; }
        .danger { color: red; font-weight: bold; }
        a { text-decoration: none; }

        /* AI ì±„íŒ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìš°ì¸¡ í•˜ë‹¨ ê³ ì •) */
        #chatModal {
            display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000; /* ì œì¼ ìœ„ì— ëœ¨ê²Œ í•¨ */
            flex-direction: column;
            border: 1px solid #ddd;
            min-width: 300px;   /* ë„ˆë¬´ ì‘ì•„ì§ ë°©ì§€ */
            max-width: 800px;
        }

        /* ì±„íŒ…ì°½ í—¤ë” */
        .chat-header {
            background-color: #0d6efd; /* íŒŒë€ìƒ‰ */
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        /* ë‹«ê¸° ë²„íŠ¼ */
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        /* ì±„íŒ… ë‚´ìš© ì˜ì—­ */
        .chat-box {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f1f3f5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .message { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; word-wrap: break-word; }
        .my-message { align-self: flex-end; background-color: #ffe066; color: black; border-bottom-right-radius: 0; }
        .ai-message { align-self: flex-start; background-color: white; border: 1px solid #ddd; border-bottom-left-radius: 0; }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        .input-area {
            padding: 10px;
            background-color: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 5px;
        }
        #sendBtn{
            white-space: nowrap;
            flex-shrink: 0;
            width: auto;
        }
    </style>
</head>
<body class="container py-5">

<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h2 class="m-0">ğŸ“‹ ìì¬ í˜„í™© ë¦¬ìŠ¤íŠ¸</h2>
    <div class="d-flex align-items-center gap-2">
            <span class="me-3 fw-bold text-secondary">
                ğŸ‘¤ <span sec:authentication="name">ì‚¬ìš©ì</span>ë‹˜
            </span>

        <button sec:authorize="hasRole('ADMIN')"
                id="approvalBtn"
                onclick="openApprovalModal()"
                class="btn btn-warning btn-sm fw-bold text-white">
            ğŸ”” ê²°ì¬ ëŒ€ê¸° (<span id="pendingCount">0</span>)
        </button>

        <a href="/product/upload" class="btn btn-primary btn-sm">â• ì—‘ì…€ ë“±ë¡</a>
        <button onclick="toggleChat()" class="btn btn-success btn-sm">ğŸ¤– AI ë¹„ì„œ</button>
        <a href="/logout" class="btn btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<table class="table table-hover">
    <thead>
    <tr>
        <th>ID</th>
        <th>í’ˆëª©ëª…</th>
        <th>ë‹¨ê°€</th>
        <th>í˜„ì¬ê³ </th>
        <th>ì•ˆì „ì¬ê³ </th>
        <th>ìƒíƒœ</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${productList}">
        <td th:text="${item.id}">1</td>
        <td th:text="${item.name}">í’ˆëª©ëª…</td>
        <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + 'ì›'}">10,000ì›</td>
        <td th:text="${item.stockQuantity}">100</td>
        <td th:text="${item.safetyStock}">10</td>
        <td>
            <span th:if="${item.stockQuantity < item.safetyStock}" class="badge bg-danger">ğŸš¨ ë°œì£¼í•„ìš”</span>
            <span th:unless="${item.stockQuantity < item.safetyStock}" class="badge bg-success">ì •ìƒ</span>
        </td>
    </tr>
    </tbody>
</table>

<div id="approvalModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="background: white; width: 600px; margin: 100px auto; padding: 20px; border-radius: 10px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h3 class="mb-3">ğŸ“‘ ê²°ì¬ ëŒ€ê¸° ëª©ë¡</h3>
        <button onclick="closeApprovalModal()" style="position: absolute; top: 15px; right: 20px; border: none; background: transparent; font-size: 24px; cursor: pointer;">&times;</button>

        <table class="table table-bordered mb-0">
            <thead class="table-light">
            <tr>
                <th>í’ˆëª©</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê¸°ì•ˆì</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="approvalListBody">
            </tbody>
        </table>
    </div>
</div>

<div id="chatModal">
    <div class="chat-header">
        <span>ğŸ¤– AI ì¬ê³  ë¹„ì„œ</span>
        <button class="close-btn" onclick="toggleChat()">&times;</button>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="message ai-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <div class="input-area">
        <input type="text" id="questionInput" class="form-control" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="handleEnter(event)">
        <button onclick="sendQuestion()" id="sendBtn" class="btn btn-primary btn-sm">ì „ì†¡</button>
    </div>
</div>

<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê°œìˆ˜ í™•ì¸
    document.addEventListener("DOMContentLoaded", function() {
        //ê´€ë¦¬ì ë²„íŠ¼ì´ í™”ë©´ì— ì¡´ì¬í•  ë•Œ
        if(document.getElementById('approvalBtn')){
        fetchPendingApprovals();
        }
        $("#chatModal").resizable({
            handles: "all",
            minHeight: 400,
            minWidth: 300
        });
        $("#chatModal").draggable({ handle: ".chat-header" });
    });

    // ì„œë²„ì—ì„œ ëŒ€ê¸° ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (AJAX)
    function fetchPendingApprovals() {
        fetch('/api/approval/pending')
            .then(response => response.json())
            .then(data => {
                // ì•Œë¦¼ ë°°ì§€ ìˆ«ì ì—…ë°ì´íŠ¸
                document.getElementById('pendingCount').innerText = data.length;
                renderApprovalList(data);
            })
            .catch(error => console.error("ê²°ì¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
    }

    // ëª¨ë‹¬ ì—´ê¸°
    function openApprovalModal() {
        fetchPendingApprovals(); // ì—´ ë•Œë§ˆë‹¤ ìµœì‹ í™”
        document.getElementById('approvalModal').style.display = 'block';
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeApprovalModal() {
        document.getElementById('approvalModal').style.display = 'none';
    }

    // ëª©ë¡ ê·¸ë¦¬ê¸°
    function renderApprovalList(list) {
        const tbody = document.getElementById('approvalListBody');
        tbody.innerHTML = ''; // ì´ˆê¸°í™”

        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">ëŒ€ê¸° ì¤‘ì¸ ê²°ì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        list.forEach(item => {
            // item.productê°€ ìˆìœ¼ë©´ ì´ë¦„ ì‚¬ìš©, ì—†ìœ¼ë©´ ì˜ˆì™¸ì²˜ë¦¬
            const productName = item.product ? item.product.name : "ìƒí’ˆì •ë³´ì—†ìŒ";

            const row = `
                <tr>
                    <td>${productName}</td>
                    <td>${item.quantity}ê°œ</td>
                    <td>${item.requesterName}</td>
                    <td>
                        <button onclick="processApproval(${item.id}, 'approve')" class="btn btn-success btn-sm">ìŠ¹ì¸</button>
                        <button onclick="processApproval(${item.id}, 'reject')" class="btn btn-danger btn-sm">ë°˜ë ¤</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // ìŠ¹ì¸/ë°˜ë ¤ ì²˜ë¦¬
    function processApproval(id, action) {
        if(!confirm(action === 'approve' ? "ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/approval/${id}/${action}`, { method: 'POST' })
            .then(response => {
                if(response.ok) {
                    alert("ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    fetchPendingApprovals(); // ëª¨ë‹¬ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    // ìŠ¹ì¸ì˜ ê²½ìš° ì¬ê³ ê°€ ë³€í•˜ë¯€ë¡œ ë’·ë°°ê²½ í…Œì´ë¸”ë„ ìƒˆë¡œê³ ì¹¨
                    if(action === 'approve') refreshTable();
                } else {
                    alert("ì²˜ë¦¬ ì‹¤íŒ¨!");
                }
            });
    }
    // ì±„íŒ…ì°½ ì—´ê³  ë‹«ê¸° í•¨ìˆ˜
    function toggleChat() {
        const modal = document.getElementById('chatModal');
        // í˜„ì¬ ì•ˆ ë³´ì´ë©´ -> ë³´ì´ê²Œ(flex), ë³´ì´ë©´ -> ìˆ¨ê¸°ê²Œ(none)
        if (modal.style.display === 'none' || modal.style.display === '') {
            modal.style.display = 'flex';
            document.getElementById('questionInput').focus(); // ì—´ë¦¬ìë§ˆì ì…ë ¥ì°½ì— ì»¤ì„œ
        } else {
            modal.style.display = 'none';
        }
    }
    //í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì—†ì´ í‘œë§Œ ì—…ë°ì´íŠ¸
    async function refreshTable() {
        try {
            // 1. í˜„ì¬ í˜ì´ì§€ ì£¼ì†Œ('/product/list')ë¡œ ì¡°ìš©íˆ ìš”ì²­ì„ ë³´ëƒ„
            const response = await fetch(window.location.href);
            const htmlText = await response.text();

            // 2. ë°›ì•„ì˜¨ HTML í…ìŠ¤íŠ¸ë¥¼ ê°€ìƒì˜ ë¬¸ì„œ(Virtual DOM)ë¡œ ë³€í™˜
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            // 3. ê°€ìƒ ë¬¸ì„œì—ì„œ ìµœì‹  'tbody'ë§Œ ì™ ë½‘ì•„ëƒ„
            const newTbody = doc.querySelector('tbody');

            // 4. í˜„ì¬ í™”ë©´ì˜ 'tbody'ë¥¼ ì°¾ì•„ì„œ ë‚´ìš©ë§Œ êµì²´
            const currentTbody = document.querySelector('tbody');
            if (newTbody && currentTbody) {
                currentTbody.innerHTML = newTbody.innerHTML;

                // (ì„ íƒì‚¬í•­) ì—…ë°ì´íŠ¸ ëë‹¤ëŠ” ê±¸ ì‹œê°ì ìœ¼ë¡œ ì•Œë ¤ì£¼ê¸° ìœ„í•´ ê¹œë¹¡ì„ íš¨ê³¼
                currentTbody.style.transition = "background-color 0.5s";
                currentTbody.style.backgroundColor = "#e8f0fe"; // ì‚´ì§ íŒŒë€ìƒ‰
                setTimeout(() => {
                    currentTbody.style.backgroundColor = "transparent";
                }, 500);
            }
            fetchPendingApprovals();
        } catch (error) {
            console.error("í‘œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
        }
    }

    // ì§ˆë¬¸ ì „ì†¡ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼ ë¡œì§)
    async function sendQuestion() {
        const input = document.getElementById('questionInput');
        const chatBox = document.getElementById('chatBox');
        const sendBtn = document.getElementById('sendBtn');
        const question = input.value.trim();

        if (!question) return;

        addMessage(question, 'my-message');
        input.value = '';
        input.disabled = true;
        sendBtn.disabled = true;

        // ë¡œë”© í‘œì‹œ
        const loadingId = 'loading-' + Date.now();
        addMessage('...', 'ai-message', loadingId);

        try {
            // API í˜¸ì¶œ
            const response = await fetch(`/ai/ask?q=${encodeURIComponent(question)}`);
            const answer = await response.text();

            // ë¡œë”©ì„ ì§„ì§œ ë‹µë³€ìœ¼ë¡œ êµì²´
            const loadingBubble = document.getElementById(loadingId);
            if (loadingBubble) {
                loadingBubble.innerText = answer;
                // ì¤„ë°”ê¿ˆ ë¬¸ì(\n)ê°€ ìˆìœ¼ë©´ HTML ì¤„ë°”ê¿ˆ(<br>)ìœ¼ë¡œ ë³€ê²½í•´ì„œ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì½”ë“œ ì‚¬ìš©
                // loadingBubble.innerHTML = answer.replace(/\n/g, '<br>');
            } else {
                addMessage(answer, 'ai-message');
            }
            // AIê°€ ì¼ì„ í–ˆë‹¤ë©´, í™”ë©´ ìë™ ê°±ì‹ 
            if (answer.includes("ì™„ë£Œ") || answer.includes("ì„±ê³µ") || answer.includes("ì·¨ì†Œ")) {
                // ì‚¬ìš©ìê°€ ë‹µë³€ì„ ì½ì„ ì‹œê°„(1.5ì´ˆ)ì„ ì£¼ê³  ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    refreshTable();
                }, 1000);
            }
        } catch (error) {
            const loadingBubble = document.getElementById(loadingId);
            if (loadingBubble) loadingBubble.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        } finally {
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
    }

    function addMessage(text, className, id = null) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.classList.add('message', className);
        div.innerText = text;
        if (id) div.id = id;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function handleEnter(event) {
        if (event.key === 'Enter') sendQuestion();
    }
</script>
</body>
</html>