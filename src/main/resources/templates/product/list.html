<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>ìì¬ ëª©ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* ê¸°ë³¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; vertical-align: middle; }
        th { background-color: #f8f9fa; }
        .danger { color: red; font-weight: bold; }
        a { text-decoration: none; }

        /* AI ì±„íŒ… ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ìš°ì¸¡ í•˜ë‹¨ ê³ ì •) */
        #chatModal {
            display: none; /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 350px;
            height: 500px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000; /* ì œì¼ ìœ„ì— ëœ¨ê²Œ í•¨ */
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        /* ì±„íŒ…ì°½ í—¤ë” */
        .chat-header {
            background-color: #0d6efd; /* íŒŒë€ìƒ‰ */
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        /* ë‹«ê¸° ë²„íŠ¼ */
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        /* ì±„íŒ… ë‚´ìš© ì˜ì—­ */
        .chat-box {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f1f3f5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .message { max-width: 80%; padding: 10px; border-radius: 10px; font-size: 14px; word-wrap: break-word; }
        .my-message { align-self: flex-end; background-color: #ffe066; color: black; border-bottom-right-radius: 0; }
        .ai-message { align-self: flex-start; background-color: white; border: 1px solid #ddd; border-bottom-left-radius: 0; }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        .input-area {
            padding: 10px;
            background-color: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 5px;
        }
        #sendBtn{
            white-space: nowrap;
            flex-shrink: 0;
            width: auto;
        }
    </style>
</head>
<body class="container py-5">

<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h2 class="m-0">ğŸ“‹ ìì¬ í˜„í™© ë¦¬ìŠ¤íŠ¸</h2>
    <div class="d-flex align-items-center gap-2">
            <span class="me-3 fw-bold text-secondary">
                ğŸ‘¤ <span sec:authentication="name">ì‚¬ìš©ì</span>ë‹˜
            </span>
        <a href="/product/upload" class="btn btn-primary btn-sm">â• ì—‘ì…€ ë“±ë¡</a>

        <button onclick="toggleChat()" class="btn btn-success btn-sm">ğŸ¤– AI ë¹„ì„œ</button>

        <a href="/logout" class="btn btn-danger btn-sm">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</div>

<table class="table table-hover">
    <thead>
    <tr>
        <th>ID</th>
        <th>í’ˆëª©ëª…</th>
        <th>ë‹¨ê°€</th>
        <th>í˜„ì¬ê³ </th>
        <th>ì•ˆì „ì¬ê³ </th>
        <th>ìƒíƒœ</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${productList}">
        <td th:text="${item.id}">1</td>
        <td th:text="${item.name}">í’ˆëª©ëª…</td>
        <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + 'ì›'}">10,000ì›</td>
        <td th:text="${item.stockQuantity}">100</td>
        <td th:text="${item.safetyStock}">10</td>
        <td>
            <span th:if="${item.stockQuantity < item.safetyStock}" class="badge bg-danger">ğŸš¨ ë°œì£¼í•„ìš”</span>
            <span th:unless="${item.stockQuantity < item.safetyStock}" class="badge bg-success">ì •ìƒ</span>
        </td>
    </tr>
    </tbody>
</table>

<div id="chatModal">
    <div class="chat-header">
        <span>ğŸ¤– AI ì¬ê³  ë¹„ì„œ</span>
        <button class="close-btn" onclick="toggleChat()">&times;</button>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="message ai-message">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
    </div>

    <div class="input-area">
        <input type="text" id="questionInput" class="form-control" placeholder="ì§ˆë¬¸ ì…ë ¥..." onkeypress="handleEnter(event)">
        <button onclick="sendQuestion()" id="sendBtn" class="btn btn-primary btn-sm">ì „ì†¡</button>
    </div>
</div>

<script>
    // ì±„íŒ…ì°½ ì—´ê³  ë‹«ê¸° í•¨ìˆ˜
    function toggleChat() {
        const modal = document.getElementById('chatModal');
        // í˜„ì¬ ì•ˆ ë³´ì´ë©´ -> ë³´ì´ê²Œ(flex), ë³´ì´ë©´ -> ìˆ¨ê¸°ê²Œ(none)
        if (modal.style.display === 'none' || modal.style.display === '') {
            modal.style.display = 'flex';
            document.getElementById('questionInput').focus(); // ì—´ë¦¬ìë§ˆì ì…ë ¥ì°½ì— ì»¤ì„œ
        } else {
            modal.style.display = 'none';
        }
    }
    //í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ì—†ì´ í‘œë§Œ ì—…ë°ì´íŠ¸
    async function refreshTable() {
        try {
            // 1. í˜„ì¬ í˜ì´ì§€ ì£¼ì†Œ('/product/list')ë¡œ ì¡°ìš©íˆ ìš”ì²­ì„ ë³´ëƒ„
            const response = await fetch(window.location.href);
            const htmlText = await response.text();

            // 2. ë°›ì•„ì˜¨ HTML í…ìŠ¤íŠ¸ë¥¼ ê°€ìƒì˜ ë¬¸ì„œ(Virtual DOM)ë¡œ ë³€í™˜
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');

            // 3. ê°€ìƒ ë¬¸ì„œì—ì„œ ìµœì‹  'tbody'ë§Œ ì™ ë½‘ì•„ëƒ„
            const newTbody = doc.querySelector('tbody');

            // 4. í˜„ì¬ í™”ë©´ì˜ 'tbody'ë¥¼ ì°¾ì•„ì„œ ë‚´ìš©ë§Œ êµì²´
            const currentTbody = document.querySelector('tbody');
            if (newTbody && currentTbody) {
                currentTbody.innerHTML = newTbody.innerHTML;

                // (ì„ íƒì‚¬í•­) ì—…ë°ì´íŠ¸ ëë‹¤ëŠ” ê±¸ ì‹œê°ì ìœ¼ë¡œ ì•Œë ¤ì£¼ê¸° ìœ„í•´ ê¹œë¹¡ì„ íš¨ê³¼
                currentTbody.style.transition = "background-color 0.5s";
                currentTbody.style.backgroundColor = "#e8f0fe"; // ì‚´ì§ íŒŒë€ìƒ‰
                setTimeout(() => {
                    currentTbody.style.backgroundColor = "transparent";
                }, 500);
            }
        } catch (error) {
            console.error("í‘œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
        }
    }

    // ì§ˆë¬¸ ì „ì†¡ í•¨ìˆ˜ (ê¸°ì¡´ê³¼ ë™ì¼ ë¡œì§)
    async function sendQuestion() {
        const input = document.getElementById('questionInput');
        const chatBox = document.getElementById('chatBox');
        const sendBtn = document.getElementById('sendBtn');
        const question = input.value.trim();

        if (!question) return;

        addMessage(question, 'my-message');
        input.value = '';
        input.disabled = true;
        sendBtn.disabled = true;

        // ë¡œë”© í‘œì‹œ
        const loadingId = 'loading-' + Date.now();
        addMessage('...', 'ai-message', loadingId);

        try {
            // API í˜¸ì¶œ
            const response = await fetch(`/ai/ask?q=${encodeURIComponent(question)}`);
            const answer = await response.text();

            // ë¡œë”©ì„ ì§„ì§œ ë‹µë³€ìœ¼ë¡œ êµì²´
            const loadingBubble = document.getElementById(loadingId);
            if (loadingBubble) {
                loadingBubble.innerText = answer;
                // ì¤„ë°”ê¿ˆ ë¬¸ì(\n)ê°€ ìˆìœ¼ë©´ HTML ì¤„ë°”ê¿ˆ(<br>)ìœ¼ë¡œ ë³€ê²½í•´ì„œ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì½”ë“œ ì‚¬ìš©
                // loadingBubble.innerHTML = answer.replace(/\n/g, '<br>');
            } else {
                addMessage(answer, 'ai-message');
            }
            // AIê°€ ì¼ì„ í–ˆë‹¤ë©´, í™”ë©´ ìë™ ê°±ì‹ 
            if (answer.includes("ì™„ë£Œ") || answer.includes("ì„±ê³µ") || answer.includes("ì·¨ì†Œ")) {
                // ì‚¬ìš©ìê°€ ë‹µë³€ì„ ì½ì„ ì‹œê°„(1.5ì´ˆ)ì„ ì£¼ê³  ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    refreshTable();
                }, 1000);
            }
        } catch (error) {
            const loadingBubble = document.getElementById(loadingId);
            if (loadingBubble) loadingBubble.innerText = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        } finally {
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
        }
    }

    function addMessage(text, className, id = null) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.classList.add('message', className);
        div.innerText = text;
        if (id) div.id = id;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function handleEnter(event) {
        if (event.key === 'Enter') sendQuestion();
    }
</script>
</body>
</html>